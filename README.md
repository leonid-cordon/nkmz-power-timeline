# NKMZ Power Timeline

**NKMZ Power Timeline** — это интерактивная веб-панель для наглядного мониторинга
аварийных отключений питания в серверной НКМЗ по данным журнала событий Windows
(сервер **SRV3**, лог *System*, события **6005/6008**).

Живая страница панели:  
https://leonid-cordon.github.io/nkmz-power-timeline/nkmz_power_outages.html


## Что показывает панель

Для выбранного года панель позволяет:

- увидеть по годам, были ли **аварийные отключения питания** и сколько часов в сумме не было света;
- по месяцам — сколько было аварий, сколько часов без питания и мини-шкалу активности;
- по дням месяца — какие дни «пострадали» и сколько часов в каждом дне не было напряжения;
- по конкретному дню — подробную шкалу 24 часа:
  - зелёная линия — *питание есть*;
  - красные сегменты — интервалы *без питания*.

В шапке страницы отображается:

- **Период данных** (например, `2015–2025`);
- **Последнее обновление** — время последнего экспорта журнала с SRV3
  (берётся из файла `last_update.txt`).


## Источник данных

Данные берутся из **журнала событий Windows** на сервере **SRV3**:

- лог: *System*;
- событие **6005** — «Запущена служба журнала событий»  
  (используется как момент появления питания);
- событие **6008** — «Неожиданное завершение работы системы»  
  (используется как начало аварийного отключения).

С 2015 года журнал не чистился, но панель анализирует только **аварийные
(непредвиденные) отключения**. Поэтому:

- в периоде **2015–2021** на панели **нет аварийных отключений**;
  если и были отключения, то только *плановые*, мы их сейчас не учитываем;
- начиная с **2022 года** появляются реальные аварийные отключения, они и
попадают в статистику.


## Общая схема работы

Процесс состоит из двух частей:

1. **SRV3** (Windows Server 2003): раз в день и при запуске сервера
   выполняется батник, который:
   - выгружает из лога *System* события 6005 и 6008 (с 01.01.2022);
   - записывает время последнего экспорта в `last_update.txt`.

2. **Python-машина** (Windows 10 в корпоративной сети):
   - забирает CSV и `last_update.txt` с SRV3;
   - двумя Python-скриптами строит итоговый JSON `power_stats_all_years.json`;
   - копирует `power_stats_all_years.json` и `last_update.txt` в локальный клон
     репозитория Git;
   - делает `git add`, `git commit`, `git push` в репозиторий GitHub.

GitHub Pages автоматически отдаёт свежую версию панели по ссылке:

https://leonid-cordon.github.io/nkmz-power-timeline/nkmz_power_outages.html


## Файлы в репозитории

Основные файлы:

- `nkmz_power_outages.html` — разметка и текст веб-панели;
- `nkmz_power_outages.js` — логика визуализации:
  - загрузка JSON;
  - построение блока по годам;
  - строка месяцев с мини-шкалой;
  - календарь дней;
  - детальная шкала 24 часа для выбранного дня;
- `power_stats_all_years.json` — агрегированные данные по всем годам:
  - по каждому дню — интервалы отключений и суммарные минуты без питания;
  - по месяцам и годам — количество аварий, дней с отключениями и минуты без питания;
- `last_update.txt` — одна строка вида  
  `Последний экспорт журнала SRV3: DD.MM.YYYY HH:MM`  
  (панель читает эту строку и показывает её как «Последнее обновление»);
- `README.md` — это описание.

Служебные файлы редактора (`.idea/`, временные файлы и т.п.) в репозиторий не добавляются.


## Часть 1. SRV3 (экспорт журнала)

Папка на SRV3:

- `C:\NKMZ_Power`

Батник:

- `export_srv3_events_6005_6008.bat`

Что делает батник (в общих чертах):

1. Создаёт папку `C:\NKMZ_Power`, если её ещё нет.
2. Через `eventquery.vbs` выгружает из *System* события:
   - ID = 6005,
   - ID = 6008,
   начиная с `01.01.2022 00:00`.
3. Сохраняет результат в CSV:
   - `C:\NKMZ_Power\srv3_events_6005_6008_2022plus.csv`.
4. Создаёт или перезаписывает файл:
   - `C:\NKMZ_Power\last_update.txt`
   с текстом:
   `Последний экспорт журнала SRV3: DD.MM.YYYY HH:MM`.

Батник настроен в **Планировщике заданий** SRV3:

- ежедневный запуск в **01:00**;
- дополнительный запуск **при старте системы** (On startup), чтобы после
  аварийного включения свежие данные появились сразу, а не только ночью.


## Часть 2. Python-машина (обработка и публикация)

Рабочая папка для обработки:

- `D:\update_power_stats`

Важные файлы:

- `event_csv_to_json_all_years.py`  
  Читает CSV `srv3_events_6005_6008_2022plus.csv` и сохраняет все события
  6005/6008 в плоский JSON `srv3_events_6005_6008_all.json`
  (отсортированный по времени).

- `build_outages_all_years.py`  
  Читает `srv3_events_6005_6008_all.json`, строит интервалы отключений
  (по парам 6008 → 6005), склеивает пересечения и формирует структуру
  по годам, месяцам и дням. Результат записывает в
  `power_stats_all_years.json`.

- `update_nkmz_timeline.bat`  
  Главный батник на Python-машине. Последовательность шагов:
  1. Копирует с SRV3 в `D:\update_power_stats`:
     - `srv3_events_6005_6008_2022plus.csv`,
     - `last_update.txt`.
  2. Запускает:
     - `event_csv_to_json_all_years.py`,
     - `build_outages_all_years.py`.
  3. Копирует обновлённые:
     - `power_stats_all_years.json`,
     - `last_update.txt`
     в локальный репозиторий Git:
     `D:\repos\nkmz-power-timeline\`.
  4. Делает:
     - `git add last_update.txt power_stats_all_years.json`,
     - `git commit -m "Auto update power stats"`,
     - `git push origin main`.

Локальный клон репозитория GitHub:

- `D:\repos\nkmz-power-timeline`


### Планировщик заданий на Python-машине

На Windows 10 создано задание в Task Scheduler, которое:

- запускает `D:\update_power_stats\update_nkmz_timeline.bat`;
- выполняется:
  - ежедневно в **01:30**;
  - а также «При запуске компьютера» с задержкой (например, 30 минут),
    чтобы SRV3 успел включиться и отдать файлы.

Запуск идёт под нужным пользователем, с параметрами:

- выполнять даже если пользователь не вошёл в систему;
- выполнять с наивысшими правами (*Run with highest privileges*).


## Ручное обновление (быстрый чеклист)

Если нужно обновить данные вручную:

1. На SRV3:
   - вручную запустить задачу экспорта или батник `export_srv3_events_6005_6008.bat`;
   - убедиться, что в `C:\NKMZ_Power` обновились:
     - `srv3_events_6005_6008_2022plus.csv`,
     - `last_update.txt`.

2. На Python-машине:
   - открыть командную строку;
   - перейти в `D:\update_power_stats`;
   - выполнить `update_nkmz_timeline.bat`.

3. Проверить в `D:\repos\nkmz-power-timeline`, что обновились:
   - `power_stats_all_years.json`,
   - `last_update.txt`,
   и появился новый commit в GitHub.

4. Открыть:
   - https://leonid-cordon.github.io/nkmz-power-timeline/nkmz_power_outages.html
   - нажать *F5* и убедиться, что:
     - «Последнее обновление» совпадает с `last_update.txt`;
     - данные по годам/месяцам/дням соответствуют журналу.


## Лицензия и назначение

Проект предназначен для *внутреннего мониторинга* серверной площадки НКМЗ.
Публичный репозиторий на GitHub используется как удобный способ публикации
веб-панели и примера визуализации, без каких-либо гарантий и обязательств.
